@model LibraryManagement.Models.PhieuMuon
@using LibraryManagement.Extensions

@{
    ViewData["Title"] = "Chi tiết sách mượn quá hạn";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var bookFines = ViewBag.BookFines as Dictionary<int, decimal> ?? new();
}

<div class="container mt-4">
    <div class="mb-3">
        <a asp-action="Index" class="btn btn-secondary">← Quay lại</a>
    </div>

    <!-- Thông tin phiếu mượn -->
    <div class="card mb-4">
        <div class="card-header bg-danger text-white">
            <h5 class="mb-0">📋 Thông tin phiếu mượn quá hạn</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <p><strong>Mã phiếu:</strong> <span class="badge bg-dark">@Model.MaPhieuMuon</span></p>
                    <p><strong>Người mượn:</strong> @Model.NguoiMuon?.HoTen</p>
                    <p><strong>CCCD:</strong> @Model.NguoiMuon?.CCCD</p>
                    <p><strong>Điện thoại:</strong> @Model.NguoiMuon?.SoDienThoai</p>
                </div>
                <div class="col-md-6">
                    <p><strong>Ngày mượn:</strong> @Model.NgayMuon.ToString("dd/MM/yyyy")</p>
                    <p><strong>Hạn trả:</strong> <span class="badge bg-danger">@Model.HanTra.ToString("dd/MM/yyyy")</span></p>
                    <p><strong>Số ngày trễ:</strong> <span class="badge bg-warning text-dark">@ViewBag.DaysOverdue ngày</span></p>
                    <p><strong>Tiền phạt quá hạn:</strong> <span class="badge bg-danger">@ViewBag.OverdayFine.ToString("N0") VND</span></p>
                    <p><strong>Tiền phạt hư/mất:</strong> <span class="badge bg-danger">@ViewBag.DamageFine.ToString("N0") VND</span></p>
                    <p><strong>Tổng tiền phạt:</strong> <span class="badge bg-danger fs-5">@ViewBag.TotalFine.ToString("N0") VND</span></p>
                </div>
            </div>
        </div>

    </div>

    <!-- Danh sách sách mượn -->
    <div class="card mb-4">
        <div class="card-header bg-info text-white">
            <h5 class="mb-0">📚 Danh sách sách mượn (@(Model.ChiTietPhieuMuons?.Count ?? 0) cuốn)</h5>
        </div>
        <div class="card-body">
            @if (Model.ChiTietPhieuMuons != null && Model.ChiTietPhieuMuons.Count > 0)
            {
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>STT</th>
                                <th>Tên sách</th>
                                <th>Mã cuốn</th>
                                <th>Ngày trả</th>
                                <th>Tình trạng trả</th>
                                <th class="text-danger">Phạt (VND)</th>
                            </tr>
                        </thead>
                        <tbody>
                            @{
                                int stt = 1;
                                foreach (var ct in Model.ChiTietPhieuMuons)
                                {
                                    <tr>
                                        <td>@(stt++)</td>
                                        <td>@ct.CuonSach?.Sach?.TenSach</td>
                                        <td>@ct.CuonSach?.MaCuon</td>
                                        <td>
                                            @if (ct.NgayTra.HasValue)
                                            {
                                                @ct.NgayTra.Value.ToString("dd/MM/yyyy")
                                            }
                                            else
                                            {
                                                <span class="text-muted">Chưa trả</span>
                                            }
                                        </td>
                                        <td>
                                            @if (ct.TinhTrangTra.HasValue)
                                            {
                                                <span class="badge bg-secondary">@ct.TinhTrangTra.Value.GetDisplayName()</span>
                                            }
                                            else
                                            {
                                                <span class="badge bg-secondary">-</span>
                                            }
                                        </td>
                                        <td>
                                            @if (bookFines.ContainsKey(ct.CuonSachId))
                                            {
                                                <span class="text-danger">@bookFines[ct.CuonSachId].ToString("N0")</span>
                                            }
                                            else
                                            {
                                                <span>-</span>
                                            }
                                        </td>
                                    </tr>
                                }
                            }
                        </tbody>
                    </table>
                </div>
            }
            else
            {
                <div class="alert alert-info">Không có sách nào trong phiếu mượn này.</div>
            }
        </div>
    </div>
</div>