@model LibraryManagement.Models.PhieuMuon
@using LibraryManagement.Services
@using LibraryManagement.Enums

@inject IFineCalculatorService FineCalculator

@{
    ViewData["Title"] = "Chi tiết sách mượn quá hạn";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container mt-4">
    <div class="mb-3">
        <a asp-action="Index" class="btn btn-secondary">← Quay lại</a>
    </div>

    <!-- Thông tin phiếu mượn -->
    <div class="card mb-4">
        <div class="card-header bg-danger text-white">
            <h5 class="mb-0">📋 Thông tin phiếu mượn quá hạn</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <p><strong>Mã phiếu:</strong> <span class="badge bg-dark">@Model.MaPhieuMuon</span></p>
                    <p><strong>ID Người mượn:</strong> @Model.NguoiMuonId</p>
                    <p><strong>Người mượn:</strong> @Model.NguoiMuon?.HoTen</p>
                    <p><strong>CCCD:</strong> @Model.NguoiMuon?.CCCD</p>
                    <p><strong>Điện thoại:</strong> @Model.NguoiMuon?.SoDienThoai</p>
                </div>
                <div class="col-md-6">
                    <p><strong>Ngày mượn:</strong> @Model.NgayMuon.ToString("dd/MM/yyyy HH:mm")</p>
                    <p><strong>Hạn trả:</strong> <span class="badge bg-danger">@Model.HanTra.ToString("dd/MM/yyyy")</span></p>
                    <p><strong>Số ngày trễ:</strong> <span class="badge bg-warning text-dark">@ViewBag.DaysOverdue ngày</span></p>
                    <p>
                        <strong>Tình trạng mượn:</strong>
                        @if (Model.TrangThai == LibraryManagement.Enums.LoanStatus.DangMuon)
                        {
                            <span class="badge bg-danger">Đang mượn</span>
                        }
                        else if (Model.TrangThai == LibraryManagement.Enums.LoanStatus.DaTraDu)
                        {
                            <span class="badge bg-success">Đã trả đủ</span>
                        }
                        else if (Model.TrangThai == LibraryManagement.Enums.LoanStatus.QuaHan)
                        {
                            <span class="badge bg-danger">Quá hạn</span>
                        }
                    </p>
                    <p><strong>Nhân viên:</strong> @Model.NhanVien?.HoTen</p>
                </div>
            </div>
        </div>

    </div>

    <!-- Danh sách sách mượn -->
    <div class="card mb-4">
        <div class="card-header bg-info text-white">
            <h5 class="mb-0">📚 Danh sách sách mượn (@(Model.ChiTietPhieuMuons?.Count ?? 0) cuốn)</h5>
        </div>
        <div class="card-body">
            @if (Model.ChiTietPhieuMuons != null && Model.ChiTietPhieuMuons.Count > 0)
            {
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>STT</th>
                                <th>Tên sách</th>
                                <th>Tác giả</th>
                                <th>Mã cuốn</th>
                                <th>Tình trạng trả</th>
                                <th class="text-danger">Phạt (VND)</th>
                            </tr>
                        </thead>
                        <tbody>
                            @{
                                int stt = 1;
                                foreach (var item in Model.ChiTietPhieuMuons)
                                {
                                    var bookFine = ViewBag.BookFines.ContainsKey(item.CuonSachId)
                                    ? ViewBag.BookFines[item.CuonSachId]
                                    : 0;
                                    <tr>
                                        <td>@stt</td>
                                        <td><strong>@item.CuonSach?.Sach?.TenSach</strong></td>
                                        <td>@item.CuonSach?.Sach?.TacGia</td>
                                        <td><code>@item.CuonSach?.MaCuon</code></td>
                                        <td>
                                            @if (item.TinhTrangTra == null || item.TinhTrangTra == ReturnCondition.NguyenVen)
                                            {
                                                <span class="badge bg-success">Nguyên vẹn</span>
                                            }
                                            else if (item.TinhTrangTra == ReturnCondition.Hong)
                                            {
                                                <span class="badge bg-warning text-dark">Hỏng</span>
                                            }
                                            else if (item.TinhTrangTra == ReturnCondition.Mat)
                                            {
                                                <span class="badge bg-danger">Mất</span>
                                            }
                                        </td>
                                        <td class="text-danger">
                                            <strong>@bookFine.ToString("N0")</strong>
                                        </td>
                                    </tr>
                                    stt++;
                                }
                            }
                        </tbody>
                    </table>
                </div>
            }
            else
            {
                <p class="text-muted">Không có sách trong phiếu mượn này.</p>
            }
        </div>
    </div>

    <!-- Tính tiền phạt -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card border-warning">
                <div class="card-header bg-warning text-dark">
                    <h6 class="mb-0">Phạt quá hạn</h6>
                </div>
                <div class="card-body">
                    <p><strong>Số ngày trễ:</strong> @ViewBag.DaysOverdue ngày</p>
                    <p><strong>Mức phạt/ngày:</strong> 5,000 VND</p>
                    <h4 class="text-warning"><strong>@ViewBag.OverdayFine.ToString("N0") VND</strong></h4>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card border-danger">
                <div class="card-header bg-danger text-white">
                    <h6 class="mb-0">Phạt hỏng/mất sách</h6>
                </div>
                <div class="card-body">
                    <p><strong>Sách hỏng:</strong> 200,000 VND/cuốn</p>
                    <p><strong>Sách mất:</strong> 500,000 VND/cuốn</p>
                    <h4 class="text-danger"><strong>@ViewBag.DamageFine.ToString("N0") VND</strong></h4>
                </div>
            </div>
        </div>
    </div>

    <!-- Tổng tiền phạt -->
    <div class="alert alert-danger" role="alert">
        <h4 class="mb-3">💰 Tổng tiền phạt</h4>
        <div class="row">
            <div class="col-md-6">
                <p><strong>Phạt quá hạn:</strong> <span class="float-end">@ViewBag.OverdayFine.ToString("N0") VND</span></p>
                <p><strong>Phạt hỏng/mất:</strong> <span class="float-end">@ViewBag.DamageFine.ToString("N0") VND</span></p>
                <hr />
                <h5><strong>Cộng:</strong> <span class="float-end text-danger">@ViewBag.TotalFine.ToString("N0") VND</span></h5>
            </div>
        </div>
    </div>

    <!-- Danh sách phiếu phạt đã tạo  (xem lại điều kiện trên word)-->
    @if (Model.PhieuPhats != null && Model.PhieuPhats.Count > 0)
    {
        <div class="card mb-4">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">✅ Phiếu phạt đã tạo</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead class="table-light">
                            <tr>
                                <th>Mã phạt</th>
                                <th>Số tiền</th>
                                <th>Lý do</th>
                                <th>Trạng thái</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var phat in Model.PhieuPhats)
                            {
                                <tr>
                                    <td><strong>@phat.MaPhat</strong></td>
                                    <td>@phat.SoTienPhat.ToString("N0") VND</td>
                                    <td>@phat.LyDo</td>
                                    <td>
                                        @if (phat.TrangThaiThanhToan == PaymentStatus.ChuaThanhToan)
                                        {
                                            <span class="badge bg-danger">Chưa thanh toán</span>
                                        }
                                        else if (phat.TrangThaiThanhToan == PaymentStatus.ThanhToanMotPhan)
                                        {
                                            <span class="badge bg-warning text-dark">Thanh toán một phần</span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-success">Đã thanh toán</span>
                                        }
                                    </td>
                                    <td>
                                        <a href="#" class="btn btn-sm btn-primary">Chi tiết</a>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    }
    <!-- Hiển thị thông báo -->
    @if (TempData["Success"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            ✅ @TempData["Success"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }
    @if (TempData["Error"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            ❌ @TempData["Error"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }



    <!-- Form tạo phiếu phạt -->
    @if (Model.PhieuPhats == null || Model.PhieuPhats.Count == 0)
    {
        <div class="card border-success mb-4">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">➕ Tạo phiếu phạt</h5>
            </div>
            <div class="card-body">
                <form method="post" asp-action="CreateFine" asp-route-id="@Model.Id">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Số tiền phạt (VND)</label>
                            <input type="number" class="form-control" name="soTienPhat" value="@ViewBag.TotalFine" required />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Lý do phạt</label>
                            <select class="form-control" name="lyDo" required>
                                <option value="">-- Chọn lý do --</option>
                                <option value="Quá hạn">Quá hạn @ViewBag.DaysOverdue ngày (@ViewBag.OverdayFine.ToString("N0") VND)</option>
                                @if (ViewBag.DamageFine > 0)
                                {
                                    <option value="Hỏng/Mất sách">Hỏng/Mất sách (@ViewBag.DamageFine.ToString("N0") VND)</option>
                                    <option value="Quá hạn + Hỏng/Mất sách">Quá hạn + Hỏng/Mất sách (@ViewBag.TotalFine.ToString("N0") VND)</option>
                                }
                            </select>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-success">✅ Tạo phiếu phạt</button>
                </form>
            </div>
        </div>
    }
    else
    {
        <div class="alert alert-info alert-dismissible fade show" role="alert">
            <strong>ℹ️ Thông báo:</strong> Phiếu mượn này đã có phiếu phạt. Không thể tạo thêm phiếu phạt khác.
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    <div class="mb-3">
        <a asp-action="Index" class="btn btn-secondary">← Quay lại danh sách</a>
    </div>
</div>